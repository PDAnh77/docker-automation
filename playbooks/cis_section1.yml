---
- name: Apply CIS Level 1 - Section 1 (Host Audit Rules)
  hosts: swarm
  become: yes
  vars:
    script_remediate_local: "../scripts/cis_section1.sh"
    script_audit_local: "../tests/cis_section1_audit.sh"
    script_remediate_remote: "/tmp/cis_section1.sh"
    script_audit_remote: "/tmp/cis_section1_audit.sh"

  tasks:
    # --- 1. SAFETY CHECK ---
    - name: "Confirm Section 1 Execution"
      pause:
        prompt: "WARNING: Apply Auditd Rules on all nodes. Continue? (yes/no)"
      register: prompt
      when: not ansible_check_mode
      run_once: true

    - name: "Abort Execution"
      meta: end_play
      when:
        - not ansible_check_mode
        - prompt.user_input | default('no') | lower not in ['yes', 'y']

    # --- 2. PREPARATION (Copy scripts) ---
    - name: Copy Audit Script to Remote
      copy:
        src: "{{ script_audit_local }}"
        dest: "{{ script_audit_remote }}"
        mode: "0755"

    - name: Copy Remediation Script to Remote
      copy:
        src: "{{ script_remediate_local }}"
        dest: "{{ script_remediate_remote }}"
        mode: "0755"

    # --- 3. PRE-CHECK ---
    - name: Run Pre-check (Audit)
      shell: "{{ script_audit_remote }}"
      register: pre_check_output
      changed_when: false # Không báo 'Changed' vì chỉ đọc/kiểm tra
      ignore_errors: yes

    - name: Show Pre-check Results
      debug:
        msg:
          - "--- KẾT QUẢ KIỂM TRA BAN ĐẦU ---"
          - "{{ pre_check_output.stdout_lines }}"

    # --- 4. EXECUTION (Chỉ chạy nếu Pre-check có lỗi) ---
    - name: Execute Remediation Script
      shell: "{{ script_remediate_remote }}"
      register: remediate_output
      when: "'[FAIL]' in pre_check_output.stdout"

    - name: Show Remediation Log
      debug:
        var: remediate_output.stdout_lines
      when: remediate_output.changed

    # --- 5. POST-CHECK ---
    - name: Run Post-check (Audit Verify)
      shell: "{{ script_audit_remote }}"
      register: post_check_output
      changed_when: false
      when: remediate_output.changed

    - name: Show Final Results
      debug:
        msg:
          - "--- KẾT QUẢ SAU KHI CẤU HÌNH ---"
          - "{{ post_check_output.stdout_lines }}"
      when: remediate_output.changed

    # --- 6. CLEANUP ---
    - name: Cleanup Scripts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ script_remediate_remote }}"
        - "{{ script_audit_remote }}"
