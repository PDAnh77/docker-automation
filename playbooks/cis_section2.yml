---
# --- CẤU HÌNH MANAGER ---
- name: Configure Rsyslog on Manager
  hosts: managers
  become: yes
  vars:
    script_manager_local: "../scripts/cis_section2_manager.sh"
    script_manager_remote: "/tmp/cis_section2_manager.sh"

  tasks:
    # --- SAFETY CHECK ---
    - name: "Confirm Section 2 Execution"
      pause:
        prompt: "WARNING: Apply Docker daemon configuration on all nodes. Continue? (yes/no)"
      register: prompt
      when: not ansible_check_mode
      run_once: true

    - name: "Abort Execution"
      fail:
        msg: "Playbook aborted by user."
      when:
        - not ansible_check_mode
        - prompt.user_input | default('no') | lower not in ['yes', 'y']

    # --- EXECUTION ---
    - name: Copy Rsyslog Script to Manager
      copy:
        src: "{{ script_manager_local }}"
        dest: "{{ script_manager_remote }}"
        mode: "0755"

    - name: Execute Rsyslog Configuration
      shell: "{{ script_manager_remote }}"
      register: rsyslog_output
      changed_when: "'Restarting rsyslog' in rsyslog_output.stdout"

    - name: Show Rsyslog Result
      debug:
        msg: "{{ rsyslog_output.stdout_lines }}"

    - name: Cleanup Script
      file: path="{{ script_manager_remote }}" state=absent

# --- CẤU HÌNH WORKER ---
- name: Configure Docker Daemon on Workers
  hosts: workers
  become: yes
  vars:
    script_worker_remediate_local: "../scripts/cis_section2_worker.sh"
    script_worker_remediate_remote: "/tmp/cis_section2_worker.sh"
    script_worker_audit_local: "../tests/cis_section2_audit.sh"
    script_worker_audit_remote: "/tmp/cis_section2_audit.sh"
    manager_ip: "{{ groups['managers'][0] }}"

  tasks:
    - name: Copy Worker Remediation Script to Remote
      copy:
        src: "{{ script_worker_remediate_local }}"
        dest: "{{ script_worker_remediate_remote }}"
        mode: "0755"

    - name: Copy Worker Audit Script to Remote
      copy:
        src: "{{ script_worker_audit_local }}"
        dest: "{{ script_worker_audit_remote }}"
        mode: "0755"

    # --- PRE-CHECK ---
    - name: Run Pre-check (Audit)
      shell: "{{ script_worker_audit_remote }}"
      register: pre_check_output
      changed_when: false # Không báo 'Changed' vì chỉ đọc/kiểm tra
      ignore_errors: yes

    - name: Show Pre-check Results
      debug:
        msg:
          - "--- KẾT QUẢ KIỂM TRA BAN ĐẦU ---"
          - "{{ pre_check_output.stdout_lines }}"

    # Chạy script và truyền tham số IP Manager
    - name: Execute Docker Configuration Script
      shell: "{{ script_worker_remediate_remote }} {{ manager_ip }}"
      register: worker_output
      when: "'[FAIL]' in pre_check_output.stdout"

    # Hiển thị kết quả (Debug)
    - name: Show Worker Execution Result
      debug:
        msg: "{{ worker_output.stdout_lines }}"
      when: worker_output.changed

    # --- POST-CHECK ---
    - name: Run Post-check (Audit Verify)
      shell: "{{ script_worker_audit_remote }}"
      register: post_check_output
      changed_when: false
      when: worker_output.changed

    - name: Show Final Results
      debug:
        msg:
          - "--- KẾT QUẢ SAU KHI CẤU HÌNH ---"
          - "{{ post_check_output.stdout_lines }}"
      when: worker_output.changed

    - name: Cleanup Scripts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ script_worker_remediate_remote }}"
        - "{{ script_worker_audit_remote }}"
